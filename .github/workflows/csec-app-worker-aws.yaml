# -----------------------------------------------------------------------------
# Script  : .github/workflows/csec-app-worker-aws.yaml
# Purpose : Workflow to build and deploy the AWS Worker Service for cSecBridge
# -----------------------------------------------------------------------------
name: C-Sec | Deployment | Worker Service (AWS)
on: workflow_dispatch

permissions:
  id-token: write
  contents: read

env:
  SERVICE_NAME: csb-worker-aws
  SERVICE_PATH: app-worker-aws
  IMAGE_NAME: csb-worker-aws

jobs:
  # ----------------------------------
  # JOB 1: Validation (Linting & SAST)
  # ----------------------------------
  # This job performs static code analysis on the Python source code
  # and scans for security vulnerabilities.
  validate:
    name: Service Validation
    runs-on: csec-self-hosted
    environment: app-dev

    container:
      image: ${{ vars.GH_RUNNER_IMAGE }}
      credentials:
        username: ${{ secrets.GH_USER }}
        password: ${{ secrets.GH_TOKEN }}

    steps:
      # ----------------------
      # Step 1: Code Checkout
      # ----------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # ---------------------------
      # Step 2: Run Flake8 (Lint)
      # ---------------------------
      - name: Run Flake8 (Linting)
        run: flake8 ${{ env.SERVICE_PATH }}/src/

      # ---------------------------
      # Step 3: Run Bandit (SAST)
      # ---------------------------
      - name: Run Bandit (SAST)
        run: bandit -r ${{ env.SERVICE_PATH }}/src/ -ll

      # ---------------------------
      # Step 4: Run Trivy (FS Scan)
      # ---------------------------
      - name: Run Trivy (FS Scan)
        run: |
          trivy fs ${{ env.SERVICE_PATH }} \
            --scanners vuln \
            --severity HIGH,CRITICAL \
            --exit-code 1

  # ----------------------------------
  # JOB 2: Build & Push Image
  # ----------------------------------
  # This job builds the Docker image for the Worker service, scans it
  # for vulnerabilities, and pushes it to the container registry.
  build-push:
    name: Build & Push Image
    needs: [validate]
    runs-on: csec-self-hosted
    environment: app-dev

    container:
      image: ${{ vars.GH_RUNNER_IMAGE }}
      credentials:
        username: ${{ secrets.GH_USER }}
        password: ${{ secrets.GH_TOKEN }}

    outputs:
      image_uri: ${{ steps.image-def.outputs.uri }}

    steps:
      # ----------------------
      # Step 1: Code Checkout
      # ----------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # ----------------------
      # Step 2: Define Image URI
      # ----------------------
      - name: Define Image URI
        id: image-def
        run: |
          echo "uri=ghcr.io/${{ secrets.GH_USER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_OUTPUT

      # ----------------------
      # Step 3: Build Image
      # ----------------------
      - name: Build Docker Image
        run: |
          docker build -t ${{ steps.image-def.outputs.uri }} ${{ env.SERVICE_PATH }}

      # ----------------------
      # Step 4: Scan Image
      # ----------------------
      - name: Run Trivy (Image Scan)
        run: |
          trivy image ${{ steps.image-def.outputs.uri }} \
            --scanners vuln \
            --severity HIGH,CRITICAL \
            --exit-code 1

      # ----------------------
      # Step 5: Login to Registry
      # ----------------------
      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GH_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GH_USER }} --password-stdin

      # ----------------------
      # Step 6: Push Image
      # ----------------------
      - name: Push Docker Image
        run: docker push ${{ steps.image-def.outputs.uri }}

  # ----------------------------------
  # JOB 3: Deploy to DEV
  # ----------------------------------
  # This job deploys the Worker service Helm chart to the Development
  # Kubernetes cluster.
  deploy-dev:
    name: Deploy Service (DEV)
    needs: [build-push]
    runs-on: csec-self-hosted
    environment: app-dev

    env:
      AWS_REGION: ap-southeast-1
      KUBE_CONFIG_BUCKET: csec-dev-k8s-config
      NAMESPACE: csb-dev
      HELM_RELEASE_NAME: csb-worker-rel

    container:
      image: ${{ vars.GH_RUNNER_IMAGE }}
      credentials:
        username: ${{ secrets.GH_USER }}
        password: ${{ secrets.GH_TOKEN }}

    steps:
      # ----------------------
      # Step 1: Code Checkout
      # ----------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # ----------------------------------
      # Step 2: Configure AWS Credentials
      # ----------------------------------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: "arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_OIDC_ROLE }}"
          role-skip-session-tagging: true

      # ----------------------------------
      # Step 3: Retrieve Kubeconfig
      # ----------------------------------
      - name: Retrieve Kubeconfig
        run: |
          mkdir -p ~/.kube
          aws s3 cp s3://${{ env.KUBE_CONFIG_BUCKET }}/config ~/.kube/config

      # ----------------------------------
      # Step 4: Deploy Helm Chart
      # ----------------------------------
      - name: Deploy Helm Chart
        run: |
          helm upgrade --install ${{ env.HELM_RELEASE_NAME }} ${{ env.SERVICE_PATH }}/helm \
            --namespace ${{ env.NAMESPACE }} \
            --set deployment.image.uri=${{ needs.build-push.outputs.image_uri }} \
            --wait --timeout=5m

  # ----------------------------------
  # JOB 4: Verify DEV
  # ----------------------------------
  # This job performs post-deployment validation to ensure
  # the service is running in the Development cluster.
  verify-dev:
    name: Verify Service (DEV)
    needs: [deploy-dev]
    runs-on: csec-self-hosted
    environment: app-dev

    env:
      AWS_REGION: ap-southeast-1
      KUBE_CONFIG_BUCKET: csec-dev-k8s-config
      NAMESPACE: csb-dev
      HELM_RELEASE_NAME: csb-worker-rel

    container:
      image: ${{ vars.GH_RUNNER_IMAGE }}
      credentials:
        username: ${{ secrets.GH_USER }}
        password: ${{ secrets.GH_TOKEN }}

    steps:
      # ----------------------------------
      # Step 1: Configure AWS Credentials
      # ----------------------------------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: "arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_OIDC_ROLE }}"
          role-skip-session-tagging: true

      # ----------------------------------
      # Step 2: Retrieve Kubeconfig
      # ----------------------------------
      - name: Retrieve Kubeconfig
        run: |
          mkdir -p ~/.kube
          aws s3 cp s3://${{ env.KUBE_CONFIG_BUCKET }}/config ~/.kube/config

      # ----------------------------------
      # Step 3: Validate Helm Release
      # ----------------------------------
      - name: Validate Helm Release
        run: |
          helm list -n ${{ env.NAMESPACE }} | grep ${{ env.HELM_RELEASE_NAME }}

      # ----------------------------------
      # Step 4: Validate Pod Status
      # ----------------------------------
      - name: Validate Pod Status
        run: |
          kubectl get pods -n ${{ env.NAMESPACE }} -l app.kubernetes.io/instance=${{ env.HELM_RELEASE_NAME }} | grep Running

  # ----------------------------------
  # JOB 5: Deploy to QA
  # ----------------------------------
  # This job deploys the Worker service Helm chart to the QA
  # Kubernetes cluster.
  deploy-qa:
    name: Deploy Service (QA)
    needs: [build-push, verify-dev]
    runs-on: csec-self-hosted
    environment: app-qa

    env:
      AWS_REGION: ap-southeast-1
      KUBE_CONFIG_BUCKET: csec-qa-k8s-config
      NAMESPACE: csb-qa
      HELM_RELEASE_NAME: csb-worker-rel

    container:
      image: ${{ vars.GH_RUNNER_IMAGE }}
      credentials:
        username: ${{ secrets.GH_USER }}
        password: ${{ secrets.GH_TOKEN }}

    steps:
      # ----------------------
      # Step 1: Code Checkout
      # ----------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # ----------------------------------
      # Step 2: Configure AWS Credentials
      # ----------------------------------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: "arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_OIDC_ROLE }}"
          role-skip-session-tagging: true

      # ----------------------------------
      # Step 3: Retrieve Kubeconfig
      # ----------------------------------
      - name: Retrieve Kubeconfig
        run: |
          mkdir -p ~/.kube
          aws s3 cp s3://${{ env.KUBE_CONFIG_BUCKET }}/config ~/.kube/config

      # ----------------------------------
      # Step 4: Deploy Helm Chart
      # ----------------------------------
      - name: Deploy Helm Chart
        run: |
          helm upgrade --install ${{ env.HELM_RELEASE_NAME }} ${{ env.SERVICE_PATH }}/helm \
            --namespace ${{ env.NAMESPACE }} \
            --set deployment.image.uri=${{ needs.build-push.outputs.image_uri }} \
            --wait --timeout=5m

  # ----------------------------------
  # JOB 6: Verify QA
  # ----------------------------------
  # This job performs post-deployment validation to ensure
  # the service is running in the QA cluster.
  verify-qa:
    name: Verify Service (QA)
    needs: [deploy-qa]
    runs-on: csec-self-hosted
    environment: app-qa

    env:
      AWS_REGION: ap-southeast-1
      KUBE_CONFIG_BUCKET: csec-qa-k8s-config
      NAMESPACE: csb-qa
      HELM_RELEASE_NAME: csb-worker-rel

    container:
      image: ${{ vars.GH_RUNNER_IMAGE }}
      credentials:
        username: ${{ secrets.GH_USER }}
        password: ${{ secrets.GH_TOKEN }}

    steps:
      # ----------------------------------
      # Step 1: Configure AWS Credentials
      # ----------------------------------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: "arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_OIDC_ROLE }}"
          role-skip-session-tagging: true

      # ----------------------------------
      # Step 2: Retrieve Kubeconfig
      # ----------------------------------
      - name: Retrieve Kubeconfig
        run: |
          mkdir -p ~/.kube
          aws s3 cp s3://${{ env.KUBE_CONFIG_BUCKET }}/config ~/.kube/config

      # ----------------------------------
      # Step 3: Validate Helm Release
      # ----------------------------------
      - name: Validate Helm Release
        run: |
          helm list -n ${{ env.NAMESPACE }} | grep ${{ env.HELM_RELEASE_NAME }}

      # ----------------------------------
      # Step 4: Validate Pod Status
      # ----------------------------------
      - name: Validate Pod Status
        run: |
          kubectl get pods -n ${{ env.NAMESPACE }} -l app.kubernetes.io/instance=${{ env.HELM_RELEASE_NAME }} | grep Running
