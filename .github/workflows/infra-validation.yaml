name: Infrastructure Validation

# Manual trigger for validation
on: workflow_dispatch

# Permissions required for OIDC authentication
permissions:
  id-token: write # Required to request the OIDC token
  contents: read # Required for actions/checkout

jobs:
  validate-infra:
    name: Validate AWS Access
    runs-on: self-hosted
    environment: dev

    # Use the custom runner image
    container:
      image: ghcr.io/${{ github.repository_owner }}/csecbridge-runner-image:latest
      credentials:
        username: ${{ secrets.GH_USER }}
        password: ${{ secrets.GH_TOKEN }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-southeast-1
          # Role Chaining: The runner (Instance Profile) assumes this role
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/csec-devops-role-dev
          role-skip-session-tagging: true

      - name: Verify Identity
        run: |
          echo "Verifying assumed identity..."
          aws sts get-caller-identity

      - name: Create Test S3 Bucket
        run: |
          # Generate a unique bucket name
          BUCKET_NAME="csec-validation-$(date +%s)"

          echo "Attempting to create bucket: $BUCKET_NAME"
          aws s3 mb s3://$BUCKET_NAME

          # Clean up (if creation succeeded)
          aws s3 rb s3://$BUCKET_NAME
