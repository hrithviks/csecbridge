# -----------------------------------------------------------------------------
# Script  : .github/workflows/csec-k8s-app-platform.yaml
# Purpose : Workflow to build and deploy the Kubernetes platform for cSecBridge
# -----------------------------------------------------------------------------
name: C-Sec | Deployment | Kubernetes Application Platform
on: workflow_dispatch

# Permissions for the workflow
permissions:
  id-token: write
  contents: read

# Define environment variables
env:
  K8S_SERVICE_ACCOUNT: csb-app-sa
  K8S_ROLE_NAME: csb-app-deployer-role
  K8S_RB_NAME: csb-app-deployer-role-binding
  K8S_NS_PREFIX: csb

jobs:
  # ----------------------------------
  # JOB 1: Validation (Linting & SAST)
  # ----------------------------------
  # This job performs static code analysis on Kubernetes manifests
  # to ensure syntactic validity and security compliance.
  validate:
    name: Platform Validation
    runs-on: csec-self-hosted
    environment: platform-dev

    container:
      image: ${{ vars.GH_RUNNER_IMAGE }}
      credentials:
        username: ${{ secrets.GH_USER }}
        password: ${{ secrets.GH_TOKEN }}

    steps:
      # ----------------------
      # Step 1: Code Checkout
      # ----------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # ---------------------------
      # Step 2: Run Kubeconform
      # ---------------------------
      # Validates the Kubernetes YAML files against the official schemas.
      - name: Run Kubeconform (Lint)
        run: kubeconform -summary -ignore-missing-schemas -ignore-filename-pattern 'kustomization.yaml' k8s-platform-config/

      # ---------------------------
      # Step 3: Run Trivy Scanner
      # ---------------------------
      # Scans the configuration files for security vulnerabilities
      # and misconfigurations.
      - name: Run Trivy (SAST)
        run: |
          trivy config k8s-platform-config/ \
          --skip-files k8s-platform-config/base/deployment-role.yaml \
          --severity HIGH,CRITICAL \
          --exit-code 1

  # -----------------------------
  # JOB 2: Deploy to DEV Platform
  # -----------------------------
  # This job deploys the platform configuration to the Development
  # Kubernetes cluster and generates access credentials for applications.
  deploy-dev:
    name: Deploy Platform (DEV)
    needs: [validate]
    runs-on: csec-self-hosted
    environment: platform-dev

    env:
      CLUSTER_ENV: dev

    container:
      image: ${{ vars.GH_RUNNER_IMAGE }}
      credentials:
        username: ${{ secrets.GH_USER }}
        password: ${{ secrets.GH_TOKEN }}

    steps:
      # ----------------------
      # Step 1: Code Checkout
      # ----------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # ----------------------------------
      # Step 2: Configure AWS Credentials
      # ----------------------------------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ vars.AWS_REGION }}
          role-to-assume: "arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_OIDC_ROLE }}"
          role-skip-session-tagging: true

      # -----------------------------------
      # Step 3: Apply Platform Configuration
      # -----------------------------------
      - name: Apply Platform Configuration
        uses: ./.github/actions/k8s-platform/apply
        with:
          kube_config_bucket: ${{ secrets.AWS_S3_KUBE_CONFIG }}
          cluster_env: ${{ env.CLUSTER_ENV }}

      # -----------------------------------
      # Step 4: Generate and Upload App Config
      # -----------------------------------
      - name: Generate and Upload App Config
        uses: ./.github/actions/k8s-platform/config-upload
        with:
          sa_name: ${{ env.K8S_SERVICE_ACCOUNT }}
          namespace: "${{ env.K8S_NS_PREFIX }}-${{ env.CLUSTER_ENV }}"
          cluster_env: ${{ env.CLUSTER_ENV }}
          kube_config_bucket: ${{ secrets.AWS_S3_KUBE_CONFIG }}

  # ------------------------------
  # JOB 3: Verify Platform (DEV)
  # ------------------------------
  # This job performs post-deployment validation to ensure
  # platform resources exist in the Development cluster.
  verify-dev:
    name: Verify Platform (DEV)
    needs: [deploy-dev]
    runs-on: csec-self-hosted
    environment: platform-dev

    env:
      CLUSTER_ENV: dev

    container:
      image: ${{ vars.GH_RUNNER_IMAGE }}
      credentials:
        username: ${{ secrets.GH_USER }}
        password: ${{ secrets.GH_TOKEN }}

    steps:
      # ----------------------
      # Step 1: Code Checkout
      # ----------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # ----------------------------------
      # Step 2: Configure AWS Credentials
      # ----------------------------------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ vars.AWS_REGION }}
          role-to-assume: "arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_OIDC_ROLE }}"
          role-skip-session-tagging: true

      # -----------------------------------
      # Step 3: Retrieve Kubeconfig
      # -----------------------------------
      - name: Retrieve Kubeconfig
        run: |
          mkdir -p ~/.kube
          aws s3 cp s3://${{ secrets.AWS_S3_KUBE_CONFIG }}/kube-admin.conf ~/.kube/config
          chmod 600 ~/.kube/config

      # -----------------------------------
      # Step 4: Validate Platform Resources
      # -----------------------------------
      - name: Validate Platform Resources
        uses: ./.github/actions/k8s-platform/validate
        with:
          namespace: "${{ env.K8S_NS_PREFIX }}-${{ env.CLUSTER_ENV }}"
          sa_name: ${{ env.K8S_SERVICE_ACCOUNT }}
          role_name: ${{ env.K8S_ROLE_NAME }}
          rb_name: ${{ env.K8S_RB_NAME }}

  # ----------------------------
  # JOB 4: Deploy to QA Platform
  # ----------------------------
  # This job deploys the platform configuration to the QA
  # Kubernetes cluster and generates access credentials for applications.
  deploy-qa:
    name: Deploy Platform (QA)
    if: false
    needs: [verify-dev]
    runs-on: csec-self-hosted
    environment: platform-qa

    env:
      CLUSTER_ENV: qa

    container:
      image: ${{ vars.GH_RUNNER_IMAGE }}
      credentials:
        username: ${{ secrets.GH_USER }}
        password: ${{ secrets.GH_TOKEN }}

    steps:
      # ----------------------
      # Step 1: Code Checkout
      # ----------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # ----------------------------------
      # Step 2: Configure AWS Credentials
      # ----------------------------------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ vars.AWS_REGION }}
          role-to-assume: "arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_OIDC_ROLE }}"
          role-skip-session-tagging: true

      # ------------------------------------
      # Step 3: Apply Platform Configuration
      # ------------------------------------
      - name: Apply Platform Configuration
        uses: ./.github/actions/k8s-platform/apply
        with:
          kube_config_bucket: ${{ secrets.AWS_S3_KUBE_CONFIG }}
          cluster_env: ${{ env.CLUSTER_ENV }}

      # -----------------------------------
      # Step 4: Generate and Upload App Config
      # -----------------------------------
      - name: Generate and Upload App Config
        uses: ./.github/actions/k8s-platform/config-upload
        with:
          sa_name: ${{ env.K8S_SERVICE_ACCOUNT }}
          namespace: "${{ env.K8S_NS_PREFIX }}-${{ env.CLUSTER_ENV }}"
          cluster_env: ${{ env.CLUSTER_ENV }}
          kube_config_bucket: ${{ secrets.AWS_S3_KUBE_CONFIG }}

  # ------------------------------
  # JOB 5: Verify Platform (QA)
  # ------------------------------
  # This job performs post-deployment validation to ensure
  # platform resources exist in the QA cluster.
  verify-qa:
    name: Verify Platform (QA)
    if: false
    needs: [deploy-qa]
    runs-on: csec-self-hosted
    environment: platform-qa

    env:
      CLUSTER_ENV: qa

    container:
      image: ${{ vars.GH_RUNNER_IMAGE }}
      credentials:
        username: ${{ secrets.GH_USER }}
        password: ${{ secrets.GH_TOKEN }}

    steps:
      # ----------------------
      # Step 1: Code Checkout
      # ----------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # ----------------------------------
      # Step 2: Configure AWS Credentials
      # ----------------------------------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ vars.AWS_REGION }}
          role-to-assume: "arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_OIDC_ROLE }}"
          role-skip-session-tagging: true

      # -----------------------------------
      # Step 3: Retrieve Kubeconfig
      # -----------------------------------
      - name: Retrieve Kubeconfig
        run: |
          mkdir -p ~/.kube
          aws s3 cp s3://${{ secrets.AWS_S3_KUBE_CONFIG }}/kube-admin.conf ~/.kube/config
          chmod 600 ~/.kube/config

      # -----------------------------------
      # Step 4: Validate Platform Resources
      # -----------------------------------
      - name: Validate Platform Resources
        uses: ./.github/actions/k8s-platform/validate
        with:
          namespace: "${{ env.K8S_NS_PREFIX }}-${{ env.CLUSTER_ENV }}"
          sa_name: ${{ env.K8S_SERVICE_ACCOUNT }}
          role_name: ${{ env.K8S_ROLE_NAME }}
          rb_name: ${{ env.K8S_RB_NAME }}
