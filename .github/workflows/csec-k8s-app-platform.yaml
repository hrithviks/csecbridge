# -----------------------------------------------------------------------------
# Script  : .github/workflows/csec-k8s-app-platform.yaml
# Purpose : Workflow to build and deploy the Kubernetes platform for cSecBridge
# -----------------------------------------------------------------------------
name: C-Sec | Deployment | Kubernetes Application Platform
on: workflow_dispatch

permissions:
  id-token: write
  contents: read

jobs:
  # ----------------------------------
  # JOB 1: Validation (Linting & SAST)
  # ----------------------------------
  # This job performs static code analysis on Kubernetes manifests
  # to ensure syntactic validity and security compliance.
  validate:
    name: Platform Validation
    runs-on: csec-self-hosted
    environment: infra_dev

    container:
      image: ${{ vars.GH_RUNNER_IMAGE }}
      credentials:
        username: ${{ secrets.GH_USER }}
        password: ${{ secrets.GH_TOKEN }}

    steps:
      # ----------------------
      # Step 1: Code Checkout
      # ----------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # ---------------------------
      # Step 2: Run Kubeconform
      # ---------------------------
      # Validates the Kubernetes YAML files against the official schemas.
      - name: Run Kubeconform (Lint)
        run: kubeconform -summary -ignore-missing-schemas k8s-platform-config/

      # ---------------------------
      # Step 3: Run Trivy Scanner
      # ---------------------------
      # Scans the configuration files for security vulnerabilities
      # and misconfigurations.
      - name: Run Trivy (SAST)
        run: trivy config k8s-platform-config/ --severity HIGH,CRITICAL --exit-code 1

  # -----------------------------
  # JOB 2: Deploy to DEV Platform
  # -----------------------------
  # This job deploys the platform configuration to the Development
  # Kubernetes cluster and generates access credentials for applications.
  deploy-dev:
    name: Deploy Platform (DEV)
    needs: [validate]
    runs-on: csec-self-hosted
    environment: infra_dev

    env:
      AWS_REGION: ap-southeast-1
      CLUSTER_ENV: dev
      KUBE_CONFIG_BUCKET: csec-dev-k8s-config
      NAMESPACE: csb-dev
      SA_NAME: csb-app-sa

    container:
      image: ${{ vars.GH_RUNNER_IMAGE }}
      credentials:
        username: ${{ secrets.GH_USER }}
        password: ${{ secrets.GH_TOKEN }}

    steps:
      # ----------------------
      # Step 1: Code Checkout
      # ----------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # ----------------------------------
      # Step 2: Configure AWS Credentials
      # ----------------------------------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: "arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_OIDC_ROLE }}"
          role-skip-session-tagging: true

      # -----------------------------------
      # Step 3: Apply Platform Configuration
      # -----------------------------------
      - name: Apply Platform Configuration
        uses: ./.github/actions/k8s-platform/apply
        with:
          kube_config_bucket: ${{ env.KUBE_CONFIG_BUCKET }}
          cluster_env: ${{ env.CLUSTER_ENV }}

      # -----------------------------------
      # Step 4: Generate and Upload App Config
      # -----------------------------------
      - name: Generate and Upload App Config
        uses: ./.github/actions/k8s-platform/config-upload
        with:
          sa_name: ${{ env.SA_NAME }}
          namespace: ${{ env.NAMESPACE }}
          cluster_env: ${{ env.CLUSTER_ENV }}
          kube_config_bucket: ${{ env.KUBE_CONFIG_BUCKET }}

  # ------------------------------
  # JOB 3: Verify Platform (DEV)
  # ------------------------------
  # This job performs post-deployment validation to ensure
  # platform resources exist in the Development cluster.
  verify-dev:
    name: Verify Platform (DEV)
    needs: [deploy-dev]
    runs-on: csec-self-hosted
    environment: infra_dev

    env:
      AWS_REGION: ap-southeast-1
      KUBE_CONFIG_BUCKET: csec-dev-k8s-config
      NAMESPACE: csb-dev
      SA_NAME: csb-app-sa
      ROLE_NAME: csb-app-deployer-role
      RB_NAME: dev-deployer-role-binding

    container:
      image: ${{ vars.GH_RUNNER_IMAGE }}
      credentials:
        username: ${{ secrets.GH_USER }}
        password: ${{ secrets.GH_TOKEN }}

    steps:
      # ----------------------
      # Step 1: Code Checkout
      # ----------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # ----------------------------------
      # Step 2: Configure AWS Credentials
      # ----------------------------------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: "arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_OIDC_ROLE }}"
          role-skip-session-tagging: true

      # -----------------------------------
      # Step 3: Apply Platform Configuration
      # -----------------------------------
      - name: Apply Platform Configuration
        uses: ./.github/actions/k8s-platform/apply
        with:
          kube_config_bucket: ${{ env.KUBE_CONFIG_BUCKET }}
          # Verify job doesn't have CLUSTER_ENV in env, passing explicitly
          cluster_env: dev

      # -----------------------------------
      # Step 4: Validate Platform Resources
      # -----------------------------------
      - name: Validate Platform Resources
        uses: ./.github/actions/k8s-platform/validate
        with:
          namespace: ${{ env.NAMESPACE }}
          sa_name: ${{ env.SA_NAME }}
          role_name: ${{ env.ROLE_NAME }}
          rb_name: ${{ env.RB_NAME }}

  # ----------------------------
  # JOB 4: Deploy to QA Platform
  # ----------------------------
  # This job deploys the platform configuration to the QA
  # Kubernetes cluster and generates access credentials for applications.
  deploy-qa:
    name: Deploy Platform (QA)
    needs: [validate]
    runs-on: csec-self-hosted
    environment: infra_qa

    env:
      AWS_REGION: ap-southeast-1
      CLUSTER_ENV: qa
      KUBE_CONFIG_BUCKET: csec-qa-k8s-config
      NAMESPACE: csb-qa
      SA_NAME: csb-app-sa

    container:
      image: ${{ vars.GH_RUNNER_IMAGE }}
      credentials:
        username: ${{ secrets.GH_USER }}
        password: ${{ secrets.GH_TOKEN }}

    steps:
      # ----------------------
      # Step 1: Code Checkout
      # ----------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # ----------------------------------
      # Step 2: Configure AWS Credentials
      # ----------------------------------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: "arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_OIDC_ROLE }}"
          role-skip-session-tagging: true

      # -----------------------------------
      # Step 3: Apply Platform Configuration
      # -----------------------------------
      - name: Apply Platform Configuration
        uses: ./.github/actions/k8s-platform/apply
        with:
          kube_config_bucket: ${{ env.KUBE_CONFIG_BUCKET }}
          cluster_env: ${{ env.CLUSTER_ENV }}

      # -----------------------------------
      # Step 4: Generate and Upload App Config
      # -----------------------------------
      - name: Generate and Upload App Config
        uses: ./.github/actions/k8s-platform/config-upload
        with:
          sa_name: ${{ env.SA_NAME }}
          namespace: ${{ env.NAMESPACE }}
          cluster_env: ${{ env.CLUSTER_ENV }}
          kube_config_bucket: ${{ env.KUBE_CONFIG_BUCKET }}

  # ------------------------------
  # JOB 5: Verify Platform (QA)
  # ------------------------------
  # This job performs post-deployment validation to ensure
  # platform resources exist in the QA cluster.
  verify-qa:
    name: Verify Platform (QA)
    # Description: Validates the existence of Namespace,
    # ServiceAccount, and RBAC resources.
    needs: [deploy-qa]
    runs-on: csec-self-hosted
    environment: infra_qa

    env:
      AWS_REGION: ap-southeast-1
      KUBE_CONFIG_BUCKET: csec-qa-k8s-config
      NAMESPACE: csb-qa
      SA_NAME: csb-app-sa
      ROLE_NAME: csb-app-deployer-role
      RB_NAME: qa-deployer-role-binding

    container:
      image: ${{ vars.GH_RUNNER_IMAGE }}
      credentials:
        username: ${{ secrets.GH_USER }}
        password: ${{ secrets.GH_TOKEN }}

    steps:
      # ----------------------
      # Step 1: Code Checkout
      # ----------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # ----------------------------------
      # Step 2: Configure AWS Credentials
      # ----------------------------------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: "arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_OIDC_ROLE }}"
          role-skip-session-tagging: true

      # -----------------------------------
      # Step 3: Apply Platform Configuration
      # -----------------------------------
      - name: Apply Platform Configuration
        uses: ./.github/actions/k8s-platform/apply
        with:
          kube_config_bucket: ${{ env.KUBE_CONFIG_BUCKET }}
          # Verify job doesn't have CLUSTER_ENV in env, passing explicitly
          cluster_env: qa

      # -----------------------------------
      # Step 4: Validate Platform Resources
      # -----------------------------------
      - name: Validate Platform Resources
        uses: ./.github/actions/k8s-platform/validate
        with:
          namespace: ${{ env.NAMESPACE }}
          sa_name: ${{ env.SA_NAME }}
          role_name: ${{ env.ROLE_NAME }}
          rb_name: ${{ env.RB_NAME }}
